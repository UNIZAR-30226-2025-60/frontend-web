<template>
  <NavBar />

  <Cargando v-if="isLoading" />


   <!-- Bot√≥n para ir al chat -->
   <div class="text-center mt-4">
    <button @click="$router.push('/chatbot')" class="btn btn-primary">
      Ir al Chat
    </button>
   </div>




  <div id="pdf-container">
    <div id="nav-controls">
      <template v-if="!isLoading && isFullScreen">
        <button id="prev-button" @click="prevPage">‚¨Ö</button>
        <span id="contPagina">P√°gina {{ pageNum }} de {{ pageCount }}</span>
        <button id="next-button" @click="nextPage">‚û°</button>
        <button id="marcador" @click="toggleFavorita"> 
          <font-awesome-icon :icon="[esFavorita ? 'fas' : 'far', 'bookmark']" />
        </button>
        <div id="zoom-controls">
          <button @click="zoomOut">
            <font-awesome-icon :icon="['fas', 'minus']" />
          </button>
          <span>{{ zoomLevel.toFixed(1) }}x</span>
          <button @click="zoomIn">
            <font-awesome-icon :icon="['fas', 'plus']" />
          </button>
        </div>
      </template>

      <button v-if="!isLoading && !isFullScreen" id="pantCompleta" @click="toggleFullScreen">‚õ∂ Pantalla Completa</button>

      <canvas ref="canvas"></canvas>

    </div>
  </div>
</template>



   <script>
import { ref, onMounted, watch } from "vue";
import * as pdfjsLib from "pdfjs-dist/build/pdf";
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome';
import { library } from '@fortawesome/fontawesome-svg-core';
import { faPlus, faMinus } from '@fortawesome/free-solid-svg-icons';
import { faBookmark as regularBookmark } from '@fortawesome/free-regular-svg-icons'; // Icono vac√≠o
import { faBookmark as solidBookmark } from '@fortawesome/free-solid-svg-icons'; // Icono relleno
library.add(regularBookmark, solidBookmark, faPlus, faMinus);
import { useRoute } from "vue-router";
import { apiClient } from "../config";
import NavBar from "./NavBar.vue";
import Cargando from "./Cargando.vue";

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdn.jsdelivr.net/npm/pdfjs-dist/build/pdf.worker.min.js";

export default {
  name: "WebViewer",
  components: {
    NavBar,
    Cargando,
    FontAwesomeIcon,
  },
  setup() {
    const canvas = ref(null);
    const pageNum = ref(1);
    const pageCount = ref(0);
    const zoomLevel = ref(0.8);
    const isRendering = ref(false);
    const isLoading = ref(true);
    const isFullScreen = ref(false);
    const esFavorita = ref(false);

    let pdfDoc = null;
    const route = useRoute();
    const correo = ref(""); // Guardar correo del usuario

    console.log("üìÑ URL recibida en el visor:", route.query.url);

    // ‚úÖ Obtener el usuario autenticado desde el backend
    const loadUser = async () => {
      try {
        const response = await apiClient.get("/user", { withCredentials: true });
        correo.value = response.data.correo;
        console.log("üì© Correo obtenido del backend:", correo.value);
      } catch (error) {
        console.error("‚ùå Error al obtener el usuario:", error);
        correo.value = null;
      }
    };

    const libroUrl = route.query.url;

    const verificarFavorita = async () => {
      if (!correo.value) return;
      try {
        const { data } = await apiClient.get("/verificar-favorita", {
          params: { correo: correo.value, enlace: libroUrl, pagina: pageNum.value },
        });
        esFavorita.value = data.esFavorita;
        console.log(`‚≠ê Estado de favorita: ${esFavorita.value}`);
      } catch (error) {
        console.error("‚ö†Ô∏è No se pudo verificar si la p√°gina es favorita:", error);
      }
    };

     // ‚úÖ Renderizar p√°gina
     const renderPage = async (num) => {
      if (!pdfDoc) {
        console.error("‚ùå pdfDoc es `null`");
        return;
      }
      if (isRendering.value) {
        console.warn("‚ö†Ô∏è Render en proceso, esperando...");
        return;
      }

      isRendering.value = true;

      try {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: zoomLevel.value });
        const context = canvas.value.getContext("2d");

        canvas.value.height = viewport.height;
        canvas.value.width = viewport.width;
        context.clearRect(0, 0, canvas.value.width, canvas.value.height);
        await page.render({ canvasContext: context, viewport }).promise;

        console.log(`‚úÖ P√°gina ${num} renderizada`);
        // üõ† Guardar la p√°gina solo si el usuario est√° autenticado
        if (!correo.value) {
          console.error("‚ö†Ô∏è No se puede guardar la p√°gina: usuario no autenticado.");
          return;
        }

        await apiClient.post(
          "/guardar-pagina",
          {
            correo: correo.value,
            libro_id: libroUrl,
            pagina: num,
          },
          { withCredentials: true }
        );

          await verificarFavorita();
        } catch (error) {
          console.error("‚ùå Error renderizando:", error);
        } finally {
          isRendering.value = false;
        }
    };

    const loadPdf = async () => {
      try {
        console.log("üìÑ URL recibida en el visor:", route.query.url);

        const pdfUrl = decodeURIComponent(route.query.url);
        console.log("‚úÖ URL decodificada en WebViewer:", pdfUrl);

        pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
        pageCount.value = pdfDoc.numPages;

        try {
          const { data } = await apiClient.get("/ultima-pagina", {
            params: { correo: correo.value, libro_id: libroUrl },
          });

          pageNum.value = data.pagina || 1;
        } catch (error) {
          console.error("‚ùå Error al obtener la √∫ltima p√°gina:", error);
          pageNum.value = 1;
        }

        console.log("üîÑ Renderizando p√°gina inicial:", pageNum.value);
        await renderPage(pageNum.value);

        isLoading.value = false;
      } catch (error) {
        console.error("‚ùå Error al cargar el PDF:", error);
        alert("Error al cargar el PDF. Verifica que el archivo est√° disponible.");
        isLoading.value = false;
      }
    };

    onMounted(async () => {
      await loadUser(); // Primero obtener el usuario autenticado
      await loadPdf();  // Luego cargar el PDF
    });

    // üîÑ Escuchar cambios de p√°gina y verificar si es favorita
    watch(pageNum, async () => {
      
      await verificarFavorita();
    });

    const prevPage = () => {
      if (pageNum.value <= 1) return;
      pageNum.value--;
      renderPage(pageNum.value);
    };

    const nextPage = () => {
      if (pageNum.value >= pageCount.value) return;
      pageNum.value++;
      renderPage(pageNum.value);
    };

    const zoomIn = () => {
      zoomLevel.value += 0.2;
      renderPage(pageNum.value);
    };

    const zoomOut = () => {
      if (zoomLevel.value <= 0.6) return;
      zoomLevel.value -= 0.2;
      renderPage(pageNum.value);
    };

    const toggleFullScreen = () => {
      const elem = document.getElementById("pdf-container");

      if (!document.fullscreenElement) {
        elem.requestFullscreen()
          .then(() => {
            isFullScreen.value = true;
            zoomLevel.value = 1.1; // ‚úÖ Ajustar zoom a 1.1 en pantalla completa
            renderPage(pageNum.value);
          })
          .catch((err) => {
            console.error("‚ùå Error al intentar pantalla completa:", err);
          });
      } else {
        document.exitFullscreen();
      }
    };

    document.addEventListener("fullscreenchange", () => {
      if (!document.fullscreenElement) {
        isFullScreen.value = false;
        zoomLevel.value = 0.8; // ‚úÖ Restablecer zoom a 0.7 cuando se salga de pantalla completa
        renderPage(pageNum.value);
      }
    });

    const toggleFavorita = async () => {
      if (!correo.value) {
        alert("Debes iniciar sesi√≥n para guardar favoritas.");
        return;
      }
      if (!libroUrl) {
        console.error("‚ùå No se puede gestionar favorito: libro no definido.");
        return;
      }
      
      try {
        await verificarFavorita();
        
        if (esFavorita.value) {
          // üóë Eliminar de favoritos
          await apiClient.delete("/eliminar-favorita", {
            data: { correo: correo.value, enlace: libroUrl, pagina: pageNum.value },
            withCredentials: true,
          });
          console.log("üöÆ P√°gina eliminada de favoritos");
        } else {
          // ‚≠ê Guardar en favoritos
          await apiClient.post("/guardar-favorita", {
            correo: correo.value,
            enlace: libroUrl,
            pagina: pageNum.value,
          }, { withCredentials: true });
          console.log("‚úÖ P√°gina a√±adida a favoritos");
        }
        
        esFavorita.value = !esFavorita.value; // Alternar el estado del icono
        console.log("üåü Estado de favorita:", esFavorita.value);
      } catch (error) {
        console.error("‚ùå Error al gestionar favorita:", error.response ? error.response.data : error);
        alert("Error al gestionar la p√°gina como favorita.");
      }
    };
   

    return { canvas, isLoading, isFullScreen, esFavorita, pageNum, pageCount, prevPage, nextPage, zoomIn, zoomOut, zoomLevel, toggleFullScreen, toggleFavorita};
  },
};
</script>


  <style scoped>
  #pdf-container {
    margin-top: 10px;
    text-align: center;
    overflow: auto;
  }
  
  #nav-controls {
    margin-top: 10px;
  }
  
  canvas {
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  
  button {
    margin: 0 5px;
  }


  #contPagina {
  position: absolute;
  bottom: 30px; /* üìå Se sit√∫a en la parte inferior del PDF */
  left: 50%;
  transform: translateX(-50%); /* üìå Centrar horizontalmente */
  background: rgba(0, 0, 0, 0.5);
  color: white;
  padding: 10px 15px;
  font-size: 18px;
  font-family: Arial, sans-serif;
  border-radius: 5px;
  z-index: 10; /* üìå Asegurar que est√© sobre el PDF */
}

  #pantCompleta {
  position: absolute;
  top: 110px; /* üìå Ajustar distancia desde la parte superior */
  right: 550px; /* üìå Ajustar distancia desde el lado derecho */
  background: rgba(0, 0, 0, 0.5);
  color: white;
  border: none;
  cursor: pointer;
  font-size: 18px;
  border-radius: 5px;
  /* üìå Asegurar que el bot√≥n est√© sobre el PDF */
  z-index: 10;
}


  #marcador {
    position: absolute;
    top: 5%; /* üìå Coloca los botones a media altura */
    transform: translateY(-50%); /* üìå Centra verticalmente */
    border: none;
    padding: 15px 20px;
    cursor: pointer;
    font-size: 30px;
    right: 30%;
    font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif;
    z-index: 10; /* üìå Asegurar que est√©n sobre el PDF */
  }

  #zoom-controls {
  position: absolute;
  margin-top: 15px; /* üìå Se sit√∫a en la parte superior */
  left: 50%;
  transform: translateX(-50%); /* üìå Centrar horizontalmente */
  padding: 10px 15px;
  border-radius: 5px;
  display: flex;
  font-size: 30px;
  align-items: center;
  gap: 10px;
  z-index: 10; /* üìå Asegurar que est√© sobre el PDF */
}
#zoom-controls button {
  width: 40px; /* Aumenta el tama√±o del bot√≥n */
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%; /* Hace los botones redondos */
  background: rgba(0, 0, 0, 0.1); /* Un fondo m√°s visible */
  border: none;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

  #prev-button, #next-button {
    position: absolute;
    top: 50%; /* üìå Coloca los botones a media altura */
    transform: translateY(-50%); /* üìå Centra verticalmente */
    border: none;
    padding: 15px 20px;
    cursor: pointer;
    border-radius: 50%;
    z-index: 10; /* üìå Asegurar que est√©n sobre el PDF */
  }

  /* üìå Bot√≥n de Anterior (Izquierda) */
  #prev-button {
    left: 28%;
  }

  /* üìå Bot√≥n de Siguiente (Derecha) */
  #next-button {
    right: 30%;
  }

  /* ‚úÖ Quitar fondo y borde de los botones */
#zoom-controls button,
#marcador,
#prev-button,
#next-button {
  background: none; /* Quitar fondo */
  border: none; /* Quitar borde */
  box-shadow: none; /* Quitar sombra */
  color: black; /* Mantener color del texto o √≠cono */
  font-size: 18px;
  cursor: pointer;
  padding: 10px;
}

  </style>
  

